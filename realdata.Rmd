---
title: "Decompositions"
author: "Sophie Woodward"
date: '2023-06-08'
output:
  pdf_document:
    fig_width: 6
    fig_height: 3
    toc: yes
geometry: margin=1cm
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(sp)
library("raster")
library("dplyr")
library("sf")
library(fields)
library(gridExtra)
```

## Import Synthetic Data
```{r}
study = read.csv('/Users/sophie/Documents/SpatialConf/archived/Study_dataset_2010.csv')
adj = read.csv("/Users/sophie/Documents/SpatialConf/archived/adjacency_matrix.csv",
               header = F) # created from spacebench script

# Import geographies
us = map_data('state')

states = st_read(
  "/Users/sophie/Documents/SpatialConf/archived/tl_2010_us_county10/tl_2010_us_county10.shp"
)

study$FIPS = str_pad(study$FIPS, 5, pad = '0')
```

# Check connected Components
```{r}
graph = graph_from_adjacency_matrix(as.matrix(adj))
is_connected(graph) # returns TRUE
```

# Create Graph Laplacian
```{r}
R = diag(rowSums(adj)) - adj # graph laplacian 
E = eigen(R) # eigen component
D = E$val
G = E$vec
study_map = mutate(study, 
                   STATEFP10 = str_sub(FIPS, 1, 2),
                   COUNTYFP10 = str_sub(FIPS, 3, 5))
study_map = cbind.data.frame(study_map, G)
mapdat = left_join(states, study_map, by = c("STATEFP10", "COUNTYFP10"))

for (j in 64:3172){
  names(mapdat)[j] = paste('eig', j-63, sep = '')
}
png('images/histDreal.jpeg', height = 500, width = 500)
hist(D, main = 'Histogram of Frequencies: US Map', xlab = 'eigenvalue')
dev.off()
```

# Plot eigen on US map
```{r}
gs = list()
idxs = c(600, 1200, 1800, 2400, 2700, 3100)
eigens = names(mapdat)[63 + idxs]

for (i in 1:length(eigens)){
  gs[[i]] = ggplot(mapdat) +
  xlim(-125, -65) + 
  ylim(25, 50) +
geom_sf(aes_string(fill = eigens[i]), color = NA)+
  scale_fill_gradient2(low = "red", 
                       mid = "lightblue1",
                       high = "blue", 
                       limits = c(-0.2, 0.2)) +
  labs(title = paste('lambda =', round(D[idxs[i]],2))) + 
  theme_minimal() +
  theme(plot.title = element_text(size = 24 * 2,hjust = 0.5),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        line = element_blank(),
        axis.title = element_blank(),
        panel.grid.major = element_line(colour = "transparent"))
}

png('images/usmap.jpeg', height = 1024 * 0.6 * 2, width = 1024 * 2)
do.call(grid.arrange,gs)
dev.off()
```


# Spectral Decomposition: Plot real data component vs spatial scale
```{r}
# 2, 4-37 are the columns with data except cms
dat_spectransform = t(G) %*% as.matrix(study_map[,c(2,4:37)])
df <- data.frame(D, dat_spectransform)
colnames(df) = c('D', colnames(study_map[c(2,4:37)]))

labels = names(df)[-1]
plts = list()
for (i in 1:length(labels)){
  label = labels[i]
  plts[[i]] = ggplot(df, aes_string(x = D, y = label)) + 
      geom_line() +
      labs(x = "eigenvalue", y = "Xstar", title = label) +
      geom_hline(yintercept = 0, color = "red") +
      theme_minimal()
}

png('images/data_spectral.jpeg', height = 1024 * 0.6 * 2, width = 1024 * 2)
do.call(grid.arrange,plts)
dev.off()

# cut out nine of the lowest eigen so we can see more.
dfsub = df[1:3100,]
labels = names(df)[-1]
xlab = 'D'
plts = list()
for (i in 1:length(labels)){
  label = labels[i]
  plts[[i]] = ggplot(dfsub, aes_string(x = xlab, y = label)) + 
      geom_line() +
      labs(x = "eigenvalue", y = "Xstar", title = label) +
      geom_hline(yintercept = 0, color = "red") +
      theme_minimal()
}

png('images/data_spectral_tail.jpeg', height = 1024 * 0.6 * 2, width = 1024 * 2)
do.call(grid.arrange,plts)
dev.off()
```

## Nested Decomposition: plot real data component vs spatial scale
```{r}
groups = cbind(study$region, study$STATE)
nest = nested_decomp_mats(groups)

idxs = c(2,4:37)
plts = list()
for (i in 1:length(idxs)){
  idx = idxs[i]
  X1 = nest$decomp_mats[[1]] %*% study_map[,idx]
  X2 = nest$decomp_mats[[2]] %*% study_map[,idx]
  X3 = nest$decomp_mats[[3]] %*% study_map[,idx]
  
  df = cbind(X1, X2, X3)
  df = melt(t(df))
  colnames(df) = c('Level', 'Confounder', 'Xi')
  df$Level[df$Level == 1] = 'Region'
  df$Level[df$Level == 2] = 'State'
  df$Level[df$Level == 3] = 'County'
  plts[[i]] = ggplot(df, aes(x = factor(Level, levels = c('Region', 'State', 'County')), 
                     y = Xi)) + 
    geom_hline(yintercept = 0, color = "red") +
    geom_violin() +
    labs(title=names(study_map)[idx],
          x ="Level")
}
png('images/data_nested.jpeg', height = 1024 * 0.6 * 2, width = 1024 * 2)
do.call(grid.arrange,plts)
dev.off()
```










