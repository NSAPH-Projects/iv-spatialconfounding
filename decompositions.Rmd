---
title: "Decompositions"
author: "Sophie Woodward"
date: '2023-06-08'
output: pdf_document
---

```{r, include = F}
source('funcs.R')
library(ggplot2)
library(reshape2)
library(dplyr)
library(scatterplot3d) # update later with scatter3d (interactive)
set.seed(2)
```

# Simulation Study
Denote $X$ as exposure $X$, $Z$ as unmeasured confounder, and $Y$ as outcome. 

## Simulation 1
We simulate the following scenario 100 times. Across $n_1 = 25$ states of $5 \times 5$ grids, 
\begin{align*}
X_{1,s} &\sim \text{Exp}(1)\\
Z_{1,s} &\sim 0.9X_2 + \sqrt{1-0.9^2}\text{Exp}(1)
\end{align*}
for $s = 1, \ldots, n_1 = 25$. Across $n_2 = 625$ counties of $1 \times 1$ grids, let 
\begin{align*}
X_{2,i} &\sim \text{Exp}(1)\\
Z_{2,i} &\sim 0.001X_2 + \sqrt{1-0.001^2}\text{Exp}(1)
\end{align*}
and $X_i = X_{1,s(i)} + X_{2,i}, Z_i = Z_{1,s(i)} + Z_{2,i}$ for $i = 1, \ldots, n_2 = 625$. By construction, $X,Z$ are nearly uncorrelated within the states of $5 \times 5$, but correlated across states. (Note that this DGM exactly follows the nested decomposition.) We let $Y_i = 2X_i -Z_i + \epsilon$ where $\epsilon_i \sim \mathcal{N}(0,1)$ independently across $i$.

For each of the 100 scenarios, we decompose $X,Z,Y$ at different spatial scales using 1) nested decomposition and 2) spectral decomposition. At each spatial scale $\omega$, we obtain an estimate $\hat{\beta}(\omega)$ of $\beta =2$ from a linear regression of $Y(\omega)$ on $X(\omega)$. I hypothesize that $\hat{\beta}(\omega)$ is unbiased for high $\omega$ (finer spatial scales) since by construction confounding dissipates locally.

```{r, sim1, cache = T}
nsims = 100
nestedmat = matrix(NA, nrow = nsims, ncol = 2)
spectralmat = matrix(NA, nrow = nsims, ncol = 25)

for (num in 1:nsims){
  outsim = sim(n = 5, outcome = 'linear', 
              rhox = c(0.9, 0.001),
             decomposition = 'nested', 
             quiet = T)
  nestedmat[num,] = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  Z = outsim$Z, 
                  groups = outsim$groups,
                  decomposition = 'nested', 
                  quiet = T)
  spectralmat[num,] = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  Z = outsim$Z, 
                  groups = outsim$groups,
                  decomposition = 'spectral', 
                  quiet = T)
}


par(mfrow = c(1,2))
plot(1:2, colMeans(nestedmat), xlab = 'Spatial Scale', ylab = 'betahat', pch = 19, type = 'l', 
     main = 'Nested', xaxp = c(1,2,1), ylim = c(0.5,3))
points(1:2, colMeans(nestedmat), pch = 19)
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')

plot(1:25, colMeans(spectralmat), xlab = 'Spatial Scale', ylab = 'betahat', pch = 19,
     type = 'l', ylim = c(0.5,3), main = 'Spectral')
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')
```

\newpage
## Simulation 2
We repeat simulation 1 but now the data-generating model originates from the spectral decomposition rather than the nested. In particular, we use the graph Fourier transform to project $X$ and $Z$ into the spectral domain. In the spectral domain, 
\begin{align*}
X^*_i &\sim \text{Exp}(1)\\
Z^*_i &\sim \rho_iX_2 + \sqrt{1-\rho_i^2}\text{Exp}(1)
\end{align*}
for $i=1, \ldots, 625$ where $\rho_i = 0, 1/624, 2/624, \ldots, 1$. So the covariance between $X$ and $Z$ dissipates for smaller $i$, which corresponds to larger eigenvalues $\omega$ of the graph Laplacian, or smaller spatial scales. 

Again, for each of the 100 scenarios we decompose $X,Z,Y$ at different spatial scales using 1) nested decomposition and 2) spectral decomposition. At each spatial scale $\omega$, we obtain an estimate $\hat{\beta}(\omega)$ of $\beta =2$ from a linear regression of $Y(\omega)$ on $X(\omega)$. I hypothesize that $\hat{\beta}(\omega)$ is unbiased for high $\omega$ (finer spatial scales) since by construction confounding dissipates locally.

```{r, sim2, cache = T}
nsims = 100
nestedmat = matrix(NA, nrow = nsims, ncol = 2)
spectralmat = matrix(NA, nrow = nsims, ncol = 25)

for (num in 1:nsims){
  outsim = sim(n = 5, outcome = 'linear', 
              rhox = seq(0,1, by = 1/(5^4-1)),
             decomposition = 'spectral', 
             quiet = T)
  nestedmat[num,] = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  Z = outsim$Z, 
                  groups = outsim$groups,
                  decomposition = 'nested', 
                  quiet = T)
  spectralmat[num,] = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  Z = outsim$Z, 
                  groups = outsim$groups,
                  decomposition = 'spectral', 
                  quiet = T)
}


par(mfrow = c(1,2))
plot(1:2, colMeans(nestedmat), xlab = 'Spatial Scale', ylab = 'betahat', pch = 19, type = 'l', 
     main = 'Nested', xaxp = c(1,2,1), ylim = c(0.5,3))
points(1:2, colMeans(nestedmat), pch = 19)
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')

plot(1:25, colMeans(spectralmat), xlab = 'Spatial Scale', ylab = 'betahat', pch = 19,
     type = 'l', ylim = c(0.5,3), main = 'Spectral')
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')
```




