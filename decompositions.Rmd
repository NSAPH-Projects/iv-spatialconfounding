---
title: "Decompositions"
author: "Sophie Woodward"
date: '2023-06-08'
output:
  pdf_document:
    fig_width: 6
    fig_height: 3
    toc: true
geometry: margin=1cm
---

```{r, include = F}
source('funcs.R')
library(ggplot2)
library(reshape2)
library(dplyr)
library(scatterplot3d) # update later with scatter3d (interactive)
library(gridExtra)
set.seed(2)
```

# Key Findings (so far)
\begin{itemize}
\item When the data-generating mechanism is based on the nested decomposition, the outcome model is linear, and confounding dissipates locally (within $5 \times 5$ grids), both the nested and spectral decompositions recover unbiased estimates of the treatment effect at small spatial scales.
\item When the data-generating mechanism is based on the spectral decomposition, the outcome model is linear, and confounding dissipates locally (at high spectral frequencies), the spectral decomposition recovers unbiased estimates of the treatment effect at small spatial scales. The nested decomposition does not, in general. (Need to look at this more)
\item When the data-generating mechanism is based on the nested decomposition, the outcome model is linear, and confounding dissipates globally (confounding within $5 \times 5$ grids but not across), the nested decomposition recovers unbiased estimates of the treatment effect at large spatial scales, but the spectral does not. (Need to look at this more and check this is the case)
\item Neither decomposition can recover unbiased estimates at any scale when there is a quadratic term of exposure $X$ is included in the outcome model. 
\end{itemize}

**Note**: in the following plots, I mark the x axis by spatial scale. If I plot results from the nested decomposition, then there are only two points: spatial scale equal to $1$ is the so-called county level ($1 \times 1$ grid) and spatial scale equal to $2$ is the so-called state level ($5 \times 5$ grid). If I plot results from the spectral decomposition, then the spatial scale indexes the ordered eigenvalues of the graph Laplacian. So the spatial scales between spectral and nested plots should not be directly compared. 

\newpage
# Simulation 1: Nested DGM
Denote $X$ as exposure $X$, $Z$ as unmeasured confounder, and $Y$ as outcome. 
We simulate the following scenario 100 times. Across $n_1 = 25$ $5 \times 5$ grids, which we refer to as states,
\begin{align*}
X_{1,s} &\sim \text{Exp}(1)-1\\
Z_{1,s} &\sim 0.9X_2 + \sqrt{1-0.9^2}(\text{Exp}(1)-1)
\end{align*}
for $s = 1, \ldots, n_1 = 25$. Across $n_2 = 625$ $1 \times 1$ grids, which we refer to as counties, let 
\begin{align*}
X_{2,i} &\sim \text{Exp}(1)-1\\
Z_{2,i} &\sim 0.001X_2 + \sqrt{1-0.001^2}(\text{Exp}(1)-1)
\end{align*}
and $X_i = X_{1,s(i)} + X_{2,i}, Z_i = Z_{1,s(i)} + Z_{2,i}$ for $i = 1, \ldots, n_2 = 625$. By construction, $X,Z$ are nearly uncorrelated within the states of $5 \times 5$, but correlated across states. (Note that this DGM exactly follows the nested decomposition.) We let $Y_i = 2X_i -Z_i + \epsilon$ where $\epsilon_i \sim \mathcal{N}(0,1)$ independently across $i$.

For each of the 100 scenarios, we decompose $X,Z,Y$ at different spatial scales using 1) nested decomposition and 2) spectral decomposition. At each spatial scale $\omega$, we obtain an estimate $\hat{\beta}(\omega)$ of $\beta =2$ from a linear regression of $Y(\omega)$ on $X(\omega)$. Hypothesis: $\hat{\beta}(\omega)$ is unbiased for low $\omega$ (finer spatial scales) since by construction confounding dissipates locally.


```{r, precompute, cache=T, echo = F}
# I first compute nest and spec in this chunk so they don't have to be recomputed 
outsim = sim(n = 5, outcome = 'linear', 
              rhox = c(0.9, 0.001),
             decomposition = 'nested', 
             quiet = T)
analnested = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y,
                  groups = outsim$groups,
                  decomposition = 'nested', 
                  quiet = T, 
                  return_decomps = T)
analspectral = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  groups = outsim$groups,
                  decomposition = 'spectral', 
                  quiet = T, 
                  return_decomps = T)
nest = analnested$nest
spec = analspectral$spec
```

```{r, sim11, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox= c(0.9, 0.001), dgm='nested', nest=nest,spec=spec)
combinedplots = plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
combinedplots 
```

The true $\beta$ is plotted in red (need to add legend). Looking at the nested plot, it's reassuring to see that the bias of the coefficient is $0$ at low spatial scales when the DGM is indeed nested. Looking at the spectral plot, we see that the spectral decomposition also results in a bias of $0$ for low spatial scales. The curve here takes on an almost-stepwise shape.

Alternatively, suppose $Z$ doesn't vary at all within states. That is, for fixed $5\times 5$ grid $s'$, $Z_i = c \in \mathbb R$ $\forall i$ such that $s(i) = s'$. I accomplish this by letting $Z_{2,i} = 0$ $\forall i$ in the construction above, so $Z_i = Z_{1, s(i)}$.


```{r, sim12, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox= c(0.9, 0.001),dgm='nested', nest=nest,spec=spec,truncate = 1)
combinedplots = plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
combinedplots 
```

# Simulation 2: Spectral DGM
We repeat simulation 1 but now the data-generating model originates from the spectral decomposition rather than the nested. In particular, we use the graph Fourier transform to project $X$ and $Z$ into the spectral domain. In the spectral domain, 
\begin{align*}
X^*_i &\sim \text{Exp}(1)-1\\
Z^*_i &\sim \rho_iX_2 + \sqrt{1-\rho_i^2}(\text{Exp}(1)-1)
\end{align*}
for $i=1, \ldots, 625$ where $\rho_i = 0, 1/624, 2/624, \ldots, 1$. So the covariance between $X$ and $Z$ goes to $0$ for smaller $i$, which corresponds to larger eigenvalues $\omega$ of the graph Laplacian, or smaller spatial scales. 

Again, for each of the 100 scenarios we decompose $X,Z,Y$ at different spatial scales using 1) nested decomposition and 2) spectral decomposition. At each spatial scale $\omega$, we obtain an estimate $\hat{\beta}(\omega)$ of $\beta =2$ from a linear regression of $Y(\omega)$ on $X(\omega)$. Hypothesis:  $\hat{\beta}(\omega)$ is unbiased for low $\omega$ (finer spatial scales) since by construction confounding dissipates locally.

```{r, sim21, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox= seq(0,1, by = 1/(5^4-1)),dgm='spectral', nest=nest,spec=spec)
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

Looking at the spectral plot, it's reassuring to see that the bias of the coefficient is $0$ at low spatial scales when the DGM is indeed spectral. The estimates obtained from the nested decomposition are biased at both of the two grid levels. At first I thought that made sense: by construction the covariance is continuously decreasing with spatial scale; within a $5 \times 5$ grid we will observe bias. Let's try $\rho_i = 0$ $\forall i$. 

```{r, sim22, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=rep(0,625), dgm='spectral', nest=nest, spec=spec)
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

I am puzzled by the result. I thought making the spectral coherence equal to $0$ for all eigenvalues would result in the nested decomposition also resulting in unbiased estimates. However, this isn't the case: The nested decomposition produces estimates that are negatively biased by $0.5$. What's going on? Let's look at covariance between $X$ and $Z$ by spatial scale (next section).

# Simulation 3: Covariance by Spatial Scale
Let's plot the correlation between $X$ and $Z$ by spatial scale for both decompositions when the DGM is spectral and Cov$(X^*, Z^*)=0$ for all spatial frequencies: 

```{r, sim31, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=rep(0,625), dgm='spectral', nest=nest, spec=spec,
              objective = 'coherence')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1,1),
                     col='green')
```

Weirdly, in the spatial domain $X$ and $Z$ are still correlated at both grid levels. 

Let's repeat this with the nested DGM. Below I plot the correlation between $X$ and $Z$ by spatial scale for both decompositions when the DGM is nested and the covariance between $X$ and $Z$ equals $0$ for both grid levels: 

```{r, sim32, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0,0), dgm='nested', nest=nest, spec=spec,
              objective = 'coherence')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1,1),
                     col='green')
```

Both decompositions recover zero correlation over most spatial scales. Except the correlation for large scales of the spectral decomposition blows up...

So why is the correlation between $X$ and $Z$ at different levels of the nested decomposition nonzero when enforcing zero correlation at all spatial frequencies of the spectral decomposition?

\newpage
Suppose $Z$ doesn't vary at all until some spatial frequency. 

```{r, sim33, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=rep(0, 5^4), dgm='spectral', nest=nest, spec=spec,
              objective = 'coherence', truncate = 312)
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1,1),
                     col='green')
```

Still getting the same result. 

What if we use normal distributions for $X,Z$ instead of Expo?
In the spectral domain, 
\begin{align*}
\begin{pmatrix}
X^*_i \\ Z^*_i 
\end{pmatrix} \sim \mathcal{N}\bigg(\begin{pmatrix}0 \\ 0 \end{pmatrix}, \begin{pmatrix} 1 & \rho_i \\ \rho_i & 1 \end{pmatrix}\bigg)
\end{align*}
for $i=1, \ldots, 625$ where $\rho_i = 0$ $\forall i$.

```{r, sim34, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=rep(0, 5^4), dgm='spectral', nest=nest, spec=spec,
              objective = 'coherence', distribution = 'gaussian')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1,1),
                     col='green')
```

Ok, there we go - normality recovers what we would expect. So I need to play around with my DGM to figure out why Expo is producing weird results. Or, rather why normality is special (could it have to do with the fact the Fourier transform of a Gaussian is Gaussian and other nice properties of the normal? Or is this an error in the way I set up my DGM?) (TO DO)

\newpage
# Simulation 4: Local Confounding
Let's go back to using the Exponential DGM. We repeat simulations 1 and 2 but now confounding dissipates at larger scales rather than smaller ones.

For the nested DGM, this means
\begin{align*}
X_{1,s} &\sim \text{Exp}(1)-1\\
Z_{1,s} &\sim 0.001X_2 + \sqrt{1-0.001^2}(\text{Exp}(1)-1)
\end{align*}
for each $5 \times 5$ state, $s = 1, \ldots, n_1 = 25$. Across $n_2 = 625$ counties of $1 \times 1$ grids, let 
\begin{align*}
X_{2,i} &\sim \text{Exp}(1)-1\\
Z_{2,i} &\sim 0.9X_2 + \sqrt{1-0.9^2}(\text{Exp}(1)-1)
\end{align*}
and $X_i = X_{1,s(i)} + X_{2,i}, Z_i = Z_{1,s(i)} + Z_{2,i}$ for $i = 1, \ldots, n_2 = 625$. By construction, $X,Z$ are nearly uncorrelated across the states of $5 \times 5$, but correlated within states. 

```{r, sim41, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0.001, 0.9), dgm='nested', nest=nest, spec=spec)
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

For the spectral DGM, 
\begin{align*}
X^*_i &\sim \text{Exp}(1)-1\\
Z^*_i &\sim \rho_iX_2 + \sqrt{1-\rho_i^2}(\text{Exp}(1)-1)
\end{align*}
for $i=1, \ldots, 625$ where $\rho_i = 1, 623/624, 622/624, \ldots, 0$. 

```{r, sim42, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=seq(1,0, by = -1/(5^4-1)), dgm='spectral', nest=nest, 
              spec=spec)
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

\newpage
# Simulation 5: Outcome Model with Interaction
We repeat simulation 1 and 2 but the outcome model now includes an interaction term between $X$ and $Z$. In particular, let $Y_i = 2X_i -Z_i + 0.5X_iZ_i + \epsilon$. 

**Nested DGM**

```{r, sim51, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0.9, 0.001), dgm='nested', nest=nest, 
              spec=spec, outcome = 'interaction', betaxz=0.5)
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat, ylim = c(0.5, 4))
```

**Spectral DGM**

```{r, sim52, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=seq(0,1, by = 1/(5^4-1)), dgm='spectral', nest=nest, 
              spec=spec, outcome = 'interaction', betaxz=0.5)
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat, ylim = c(0.5, 4))
```

