---
title: "Decompositions"
author: "Sophie Woodward"
date: '2023-06-08'
output:
  pdf_document:
    fig_width: 6
    fig_height: 3
    toc: true
geometry: margin=1cm
---

```{r, include = F}
source('funcs.R')
library(ggplot2)
library(reshape2)
library(dplyr)
library(scatterplot3d) # update later with scatter3d (interactive)
library(gridExtra)
set.seed(2)
```

# Key Findings (so far)
\begin{itemize}
\item When the data-generating mechanism is based on the \textbf{nested} decomposition, the outcome model is \textbf{linear}, and confounding dissipates \textbf{locally} (within $5 \times 5$ grids), both the nested and spectral decompositions recover unbiased estimates of the treatment effect at small spatial scales.
\item When the data-generating mechanism is based on the \textbf{spectral} decomposition, the outcome model is \textbf{linear}, and confounding dissipates \textbf{locally} (at high spectral frequencies), the spectral decomposition recovers unbiased estimates of the treatment effect at small spatial scales. If the spectral correlation of exposure and confounder is equal to zero up to a small-enough frequency (big-enough spatial scale) the nested decomposition recovers nearly unbiased estimates at small spatial scales as well.
\item When the data-generating mechanism is based on the \textbf{nested} decomposition, the outcome model is \textbf{linear}, and confounding dissipates \textbf{globally} (confounding within $5 \times 5$ grids but not across), I thought the plots would be the same as the previous, but x axis (spatial scale) flipped. They are not exactly.
\item When there is an \textbf{interaction} between $X$ and $Z$ but confounding still dissipates locally, there is still near-zero bias at small spatial scales under both DGMs. At higher spatial scales bias is worse.
\item Neither decomposition can recover unbiased estimates at any scale when there is a \textbf{quadratic} term of exposure $X$ is included in the outcome model.
\end{itemize}

**Note**: in the following plots, I mark the x axis by spatial scale. If I plot results from the nested decomposition, then there are only two points: spatial scale equal to $1$ is the so-called county level ($1 \times 1$ grid) and spatial scale equal to $2$ is the so-called state level ($5 \times 5$ grid). If I plot results from the spectral decomposition, then the spatial scale indexes the ordered eigenvalues of the graph Laplacian. So the spatial scales between spectral and nested plots should not be directly compared. 

\newpage
# Simulation 1: Nested DGM
Denote $X$ as exposure $X$, $Z$ as unmeasured confounder, and $Y$ as outcome. 
We simulate the following scenario 100 times. Across $n_1 = 25$ grids of size $5 \times 5$, which we refer to as states,
\begin{align*}
X_{1,s} &\sim \text{Exp}(1)-1\\
Z_{1,s} &\sim 0.9X_2 + \sqrt{1-0.9^2}(\text{Exp}(1)-1)
\end{align*}
for $s = 1, \ldots, n_1 = 25$. Across $n_2 = 625$ grids of size $1 \times 1$, which we refer to as counties, let 
\begin{align*}
X_{2,i} &\sim \text{Exp}(1)-1\\
Z_{2,i} &\sim 0.001X_2 + \sqrt{1-0.001^2}(\text{Exp}(1)-1)
\end{align*}
and $X_i = X_{1,s(i)} + X_{2,i}, Z_i = Z_{1,s(i)} + Z_{2,i}$ for $i = 1, \ldots, n_2 = 625$. By construction, $X,Z$ are nearly uncorrelated within the states of $5 \times 5$, but correlated across states. (Note that this DGM exactly follows the nested decomposition.) Let $Y_i = 2X_i -Z_i + \epsilon$ where $\epsilon_i \sim \mathcal{N}(0,1)$ independently across $i$.

For each of the 100 scenarios, we decompose $X,Z,Y$ at different spatial scales using 1) nested decomposition and 2) spectral decomposition. At each spatial scale $\omega$, we obtain an estimate $\hat{\beta}(\omega)$ of $\beta =2$ from a linear regression of $Y(\omega)$ on $X(\omega)$. Hypothesis: $\hat{\beta}(\omega)$ is unbiased for low $\omega$ (finer spatial scales) since by construction confounding dissipates locally.


```{r, precompute, cache=T, echo = F}
# I first compute nest and spec in this chunk so they don't have to be recomputed 
outsim = sim(n = 5, outcome = 'linear', 
              rhox = c(0.9, 0.001),
             decomposition = 'nested', 
             quiet = T)
analnested = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y,
                  groups = outsim$groups,
                  decomposition = 'nested', 
                  quiet = T, 
                  return_decomps = T)
analspectral = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  groups = outsim$groups,
                  decomposition = 'spectral', 
                  quiet = T, 
                  return_decomps = T)
nest = analnested$nest
spec = analspectral$spec
```

```{r, sim11, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox= c(0.9, 0.001), dgm='nested', nest=nest,spec=spec, spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

The true $\beta$ is plotted in red (need to add legend). Looking at the nested plot, it's reassuring to see that the bias of the coefficient is $0$ at low spatial scales when the DGM is indeed nested. Looking at the spectral plot, we see that the spectral decomposition also results in a bias of $0$ for low spatial scales. The curve here takes on an almost-stepwise shape.

Alternatively, suppose $Z$ doesn't vary at all within states. That is, for fixed $5\times 5$ grid $s'$, $Z_i = c \in \mathbb R$ $\forall i$ such that $s(i) = s'$. I accomplish this by letting $Z_{2,i} = 0$ $\forall i$ in the construction above, so $Z_i = Z_{1, s(i)}$. Similar result.


```{r, sim12, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox= c(0.9, 0.001),dgm='nested', nest=nest,spec=spec,truncate = 1,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

# Simulation 2: Spectral DGM
We repeat simulation 1 but now the data-generating model originates from the spectral decomposition rather than the nested. In particular, we use the graph Fourier transform to project $X$ and $Z$ into the spectral domain. In the spectral domain, 
\begin{align*}
X^*_i &\sim \text{Exp}(1)-1\\
Z^*_i &\sim \rho_iX_2 + \sqrt{1-\rho_i^2}(\text{Exp}(1)-1)
\end{align*}
for $i=1, \ldots, 625$ where $\rho_i = 0, 1/624, 2/624, \ldots, 1$. So the covariance between $X$ and $Z$ goes to $0$ for smaller $i$, which corresponds to larger eigenvalues $\omega$ of the graph Laplacian, or smaller spatial scales. 

Again, for each of the 100 scenarios we decompose $X,Z,Y$ at different spatial scales using 1) nested decomposition and 2) spectral decomposition. At each spatial scale $\omega$, we obtain an estimate $\hat{\beta}(\omega)$ of $\beta =2$ from a linear regression of $Y(\omega)$ on $X(\omega)$. Hypothesis:  $\hat{\beta}(\omega)$ is unbiased for low $\omega$ (finer spatial scales) since by construction confounding dissipates locally.

```{r, sim21, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox= seq(0,1, by = 1/(5^4-1)),dgm='spectral', nest=nest,spec=spec,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

Looking at the spectral plot, it's reassuring to see that the bias of the coefficient is $0$ at low spatial scales when the DGM is indeed spectral. The estimates obtained from the nested decomposition are biased at both of the two grid levels. I think this makes sense: by construction the covariance is continuously decreasing with spatial scale; within a $5 \times 5$ grid we will observe bias. Let's try $\rho_i = 0$ $\forall i\leq 525$, $\rho_i = (i-525)/100$ for $526 \leq i \leq 625$. 

```{r, sim22, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(rep(0,525),seq(1/100,1,by = 1/100)), dgm='spectral', nest=nest, spec=spec,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

We observe less bias.

# Simulation 3: Correlation by Spatial Scale
Let's plot the correlation between $X$ and $Z$ by spatial scale for both decompositions using the setup from simulation 1 (nested decomposition, $\rho = (0.001,0.9)$).

```{r, sim31, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0.9,0.001), dgm='nested', nest=nest, spec=spec,
              objective = 'coherence', spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1,1),
                     col='purple')
```

Suppose $Z$ doesn't vary at all within states.

```{r, sim32, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0.9,0.001), dgm='nested', nest=nest, spec=spec,
              objective = 'coherence', truncate = 1, spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1,1),
                     col='purple')
```

\newpage
Now, let's plot the correlation between $X$ and $Z$ by spatial scale for both decompositions using the setup from simulation 2 (spectral decomposition, $\rho_i = 0, 1/624, 2/624, \ldots, 1$).

```{r, sim33, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=seq(0,1, by = 1/(5^4-1)), dgm='spectral', nest=nest, spec=spec,
              objective = 'coherence', spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1.1,1.1),
                     col='purple')
```

Suppose $Z$ doesn't vary at all for the half highest frequencies (smallest scales). 

```{r, sim34, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=seq(0,1, by = 1/(5^4-1)), dgm='spectral', nest=nest, spec=spec,
              objective = 'coherence', truncate = 312, spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, 
                     spectralmat = out$spectralmat,
                     ylab='Cor(X,Z)',
                     hline=0,
                     ylim=c(-1.1,1.1),
                     col='purple')
```

\newpage
# Simulation 4: Local Confounding
We repeat simulations 1 and 2 but now confounding dissipates at larger scales rather than smaller ones.

For the nested DGM, this means
\begin{align*}
X_{1,s} &\sim \text{Exp}(1)-1\\
Z_{1,s} &\sim 0.001X_2 + \sqrt{1-0.001^2}(\text{Exp}(1)-1)
\end{align*}
for each $5 \times 5$ state, $s = 1, \ldots, n_1 = 25$. Across $n_2 = 625$ counties of $1 \times 1$ grids, let 
\begin{align*}
X_{2,i} &\sim \text{Exp}(1)-1\\
Z_{2,i} &\sim 0.9X_2 + \sqrt{1-0.9^2}(\text{Exp}(1)-1)
\end{align*}
and $X_i = X_{1,s(i)} + X_{2,i}, Z_i = Z_{1,s(i)} + Z_{2,i}$ for $i = 1, \ldots, n_2 = 625$. By construction, $X,Z$ are nearly uncorrelated across the states of $5 \times 5$, but correlated within states. 

```{r, sim41, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0.001, 0.9), dgm='nested', nest=nest, spec=spec,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

For the spectral DGM, 
\begin{align*}
X^*_i &\sim \text{Exp}(1)-1\\
Z^*_i &\sim \rho_iX_2 + \sqrt{1-\rho_i^2}(\text{Exp}(1)-1)
\end{align*}
for $i=1, \ldots, 625$ where $\rho_i = 1, 623/624, 622/624, \ldots, 0$. 

```{r, sim42, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=seq(1,0, by = -1/(5^4-1)), dgm='spectral', nest=nest, 
              spec=spec,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat)
```

\newpage
# Simulation 5: Outcome Model with Interaction
We repeat simulation 1 and 2 but the outcome model now includes an interaction term between $X$ and $Z$. In particular, let $Y_i = 2X_i -Z_i - X_iZ_i + \epsilon$. 

**Nested DGM**

```{r, sim51, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=c(0.9, 0.001), dgm='nested', nest=nest, 
              spec=spec, outcome = 'interaction', betaxz=-1,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat, ylim = c(-4,4))
```

The bias of the estimates is worse at higher scales but still zero bias at low scales.

**Spectral DGM**

```{r, sim52, cache = T, echo = F, message = F, results = 'hide', warning = F}
out = simfunc(rhox=seq(0,1, by = 1/(5^4-1)), dgm='spectral', nest=nest, 
              spec=spec, outcome = 'interaction', betaxz=-1,spectralmethod = 'wls')
plotfunc(nestedmat = out$nestedmat, spectralmat = out$spectralmat, ylim = c(-4,4))
```

The bias of the estimates is the same as the results without an interaction... CHECK THIS

\newpage
# Simulation 6: Nonlinear Outcome Model
We repeat simulation 1 and 2 but the outcome model now includes a quadratic term of $X$. In particular, $Y_i = 2X_i + X_i^2 -Z_i + \epsilon$. The scale-specific analyses attempt to estimate both coefficients of $X$. Neither method does a good job at recovering either of the coefficients.

**Nested DGM**

```{r, sim61, cache = T, echo = F}
nsims = 100
nestedmat1 = matrix(NA, nrow = nsims, ncol = 2)
nestedmat2 = matrix(NA, nrow = nsims, ncol = 2)
spectralmat1 = matrix(NA, nrow = nsims, ncol = 625)
spectralmat2 = matrix(NA, nrow = nsims, ncol = 625)

for (num in 1:nsims){
  outsim = sim(n = 5, outcome = 'quadratic', 
              betax = c(2,1),
              rhox = c(0.9, 0.001),
             decomposition = 'nested', 
             quiet = T,
             spec = spec
             )
  nestedout = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  groups = outsim$groups,
                  decomposition = 'nested', 
                  outcome = 'quadratic',
                  quiet = T,
                  nest = nest
                  )
  nestedmat1[num,] = nestedout[1,]
  nestedmat2[num,] = nestedout[2,]

  spectralout = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  groups = outsim$groups,
                  decomposition = 'spectral', 
                  outcome = 'quadratic',
                  quiet = T,
                  spec = spec,
                  spectralmethod = 'wls'
                  )
  spectralmat1[num,] = spectralout[1,]
  spectralmat2[num,] = spectralout[2,]
}
```

```{r, sim61plotsgg, echo = F, message = F, results = 'hide', warning = F}
# Create data frames for nestedmat1, spectralmat1, nestedmat2, and spectralmat2
nested_df1 <- data.frame(Spatial_Scale = 1:2, betahat = colMeans(nestedmat1))
spectral_df1 <- data.frame(Spatial_Scale = 1:625, betahat = colMeans(spectralmat1))
nested_df2 <- data.frame(Spatial_Scale = 1:2, betahat = colMeans(nestedmat2))
spectral_df2 <- data.frame(Spatial_Scale = 1:625, betahat = colMeans(spectralmat2))

# Plot for nestedmat1
plot_nested1 <- ggplot(nested_df1, aes(x = Spatial_Scale, y = betahat-2)) +
  geom_ribbon(aes(ymin = apply(nestedmat1, 2, quantile, probs = 0.025)-2, 
                    ymax = apply(nestedmat1, 2, quantile, probs = 0.975)-2), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Nested: Linear Term') +
  ylim(-2, 2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Plot for spectralmat1
plot_spectral1 <- ggplot(spectral_df1, aes(x = Spatial_Scale, y = betahat-2)) +
  geom_ribbon(aes(ymin = apply(spectralmat1, 2, quantile, probs = 0.025)-2, 
                    ymax = apply(spectralmat1, 2, quantile, probs = 0.975)-2), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Spectral: Linear Term') +
  ylim(-2, 2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Plot for nestedmat2
plot_nested2 <- ggplot(nested_df2, aes(x = Spatial_Scale, y = betahat-1)) +
  geom_ribbon(aes(ymin = apply(nestedmat2, 2, quantile, probs = 0.025)-1, 
                    ymax = apply(nestedmat2, 2, quantile, probs = 0.975)-1), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Nested: Quadratic Term') +
  ylim(-2, 2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Plot for spectralmat2
plot_spectral2 <- ggplot(spectral_df2, aes(x = Spatial_Scale, y = betahat-1)) +
  geom_ribbon(aes(ymin = apply(spectralmat2, 2, quantile, probs = 0.025)-1, 
                    ymax = apply(spectralmat2, 2, quantile, probs = 0.975)-1), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Spectral: Quadratic Term') +
  ylim(-2, 2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Arrange the plots
combined_plots <- grid.arrange(plot_nested1, plot_spectral1, plot_nested2, plot_spectral2, ncol = 2)

# Display the combined plots
combined_plots

```


**Spectral DGM**

```{r, sim62, cache = T, echo = F}
nestedmat1 = matrix(NA, nrow = nsims, ncol = 2)
nestedmat2 = matrix(NA, nrow = nsims, ncol = 2)
spectralmat1 = matrix(NA, nrow = nsims, ncol = 625)
spectralmat2 = matrix(NA, nrow = nsims, ncol = 625)

for (num in 1:nsims){
  outsim = sim(n = 5, outcome = 'quadratic', 
              betax = c(2,1),
              rhox = seq(0,1, by = 1/(5^4-1)),
             decomposition = 'spectral', 
             quiet = T,
             spec = spec
             )
  nestedout = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  groups = outsim$groups,
                  decomposition = 'nested', 
                  outcome = 'quadratic',
                  quiet = T,
                  nest = nest
                  )
  nestedmat1[num,] = nestedout[1,]
  nestedmat2[num,] = nestedout[2,]

  spectralout = analysis(n = 5, A = outsim$A, 
                  X = outsim$X, 
                  Y = outsim$Y, 
                  groups = outsim$groups,
                  decomposition = 'spectral', 
                  outcome = 'quadratic',
                  quiet = T,
                  spec = spec,
                  spectralmethod = 'wls'
                  )
  spectralmat1[num,] = spectralout[1,]
  spectralmat2[num,] = spectralout[2,]
}
```


```{r, sim62plotsgg, echo = F, message = F, results = 'hide', warning = F}
# Create data frames for nestedmat1, spectralmat1, nestedmat2, and spectralmat2
nested_df1 <- data.frame(Spatial_Scale = 1:2, betahat = colMeans(nestedmat1))
spectral_df1 <- data.frame(Spatial_Scale = 1:625, betahat = colMeans(spectralmat1))
nested_df2 <- data.frame(Spatial_Scale = 1:2, betahat = colMeans(nestedmat2))
spectral_df2 <- data.frame(Spatial_Scale = 1:625, betahat = colMeans(spectralmat2))

# Plot for nestedmat1
plot_nested1 <- ggplot(nested_df1, aes(x = Spatial_Scale, y = betahat-2)) +
  geom_ribbon(aes(ymin = apply(nestedmat1, 2, quantile, probs = 0.025)-2, 
                    ymax = apply(nestedmat1, 2, quantile, probs = 0.975)-2), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Nested: Linear Term') +
  ylim(-2,2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Plot for spectralmat1
plot_spectral1 <- ggplot(spectral_df1, aes(x = Spatial_Scale, y = betahat-2)) +
  geom_ribbon(aes(ymin = apply(spectralmat1, 2, quantile, probs = 0.025)-2, 
                    ymax = apply(spectralmat1, 2, quantile, probs = 0.975)-2), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Spectral: Linear Term') +
  ylim(-2,2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Plot for nestedmat2
plot_nested2 <- ggplot(nested_df2, aes(x = Spatial_Scale, y = betahat-1)) +
  geom_ribbon(aes(ymin = apply(nestedmat2, 2, quantile, probs = 0.025)-1, 
                    ymax = apply(nestedmat2, 2, quantile, probs = 0.975)-1), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  geom_point(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Nested: Quadratic Term') +
  ylim(-2, 2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Plot for spectralmat2
plot_spectral2 <- ggplot(spectral_df2, aes(x = Spatial_Scale, y = betahat-1)) +
  geom_ribbon(aes(ymin = apply(spectralmat2, 2, quantile, probs = 0.025)-1, 
                    ymax = apply(spectralmat2, 2, quantile, probs = 0.975)-1), 
                fill = "lightblue") +
  geom_line(color = "blue") +
  xlab('Spatial Scale') +
  ylab('bias') +
  ggtitle('Spectral: Quadratic Term') +
  ylim(-2, 2) +
  theme_minimal() +
  geom_hline(yintercept = 0, color = 'red', linetype = 'dashed') +
  guides(color = FALSE)

# Arrange the plots
combined_plots <- grid.arrange(plot_nested1, plot_spectral1, plot_nested2, plot_spectral2, ncol = 2)

# Display the combined plots
combined_plots

```



