---
title: "Decompositions"
author: "Sophie Woodward"
date: '2023-06-08'
output: pdf_document
---

```{r, include = F}
source('funcs.R')
library(ggplot2)
library(reshape2)
library(dplyr)
library(scatterplot3d) # update later with scatter3d (interactive)
set.seed(10)
```

## Generate Data
First let's generate some data using the spectral decomposition. Note that the covariance between $X$ and $Z$ is decreasing with spatial scale by construction (see rhox - things are flipped since spectral decomp projects in order of highest to lowest freq). We assume $Y$ is a linear function of $X$ and $Z$ with coefficients $2$ and $-1$ respectively.
```{r}
par(mfrow = c(1,3))
outsim = sim(5, outcome = 'linear', rhox = seq(0,1, by = 1/(5^4-1)),
             decomposition = 'spectral')
scatterplot3d(x = outsim$coord[,1], outsim$coord[,2], outsim$X, 
              color = outsim$state, pch = 20, angle = 60, main = 'Exposure X')
scatterplot3d(x = outsim$coord[,1], outsim$coord[,2], outsim$Y, 
              color = outsim$state, pch = 20, angle = 60, main = 'Outcome Y')
scatterplot3d(x = outsim$coord[,1], outsim$coord[,2], outsim$Z, 
              main = 'Confounder Z',
              color = outsim$state, pch = 20, angle = 60)

```

## Analysis

```{r}
par(mfrow = c(1,2))
testnested = analysis(A = outsim$A, 
                X = outsim$X, 
                Y = outsim$Y, 
                Z = outsim$Z, 
                state = outsim$state,
                decomposition = 'nested')
plot(1:2, testnested, xlab = 'Spatial Scale', ylab = 'betahat', pch = 19, type = 'l', 
     main = 'Nested', xaxp = c(1,2,1), ylim = c(1,3))
points(1:2, testnested, pch = 19)
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')

testspectral = analysis(A = outsim$A, 
                X = outsim$X, 
                Y = outsim$Y, 
                Z = outsim$Z, 
                state = outsim$state,
                decomposition = 'spectral')
plot(1:5, testspectral, xlab = 'Spatial Scale', ylab = 'betahat', pch = 19,
     type = 'l', ylim = c(1,3), main = 'Spectral')
points(1:5, testspectral, pch = 19)
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')
```
Below we see that the bias of the $\hat{\beta}_x$ estimates obtained from the spectral decomposition indeed decreases with smaller spatial scale, as desired. This is also true for the nested decomposition but the bias is pretty bad for both scales.

## Repeat this with Nested DGM
Let's generate some data using the nested decomposition. The covariance between $X$ and $Z$ is decreasing with spatial scale by construction (see rhox). Note that we consider only two spatial scales for now. We assume $Y$ is a linear function of $X$ and $Z$ with coefficients $2$ and $-1$ respectively.
```{r}
par(mfrow = c(1,3))
outsim = sim(5, outcome = 'linear', rhox = c(0.9, 0.001),
             decomposition = 'nested')
scatterplot3d(x = outsim$coord[,1], outsim$coord[,2], outsim$X, 
              color = outsim$state, pch = 20, angle = 60, main = 'Exposure X')
scatterplot3d(x = outsim$coord[,1], outsim$coord[,2], outsim$Y, 
              color = outsim$state, pch = 20, angle = 60, main = 'Outcome Y')
scatterplot3d(x = outsim$coord[,1], outsim$coord[,2], outsim$Z, 
              main = 'Confounder Z',
              color = outsim$state, pch = 20, angle = 60)
```

## Repeat the analysis
Below we see that the bias of the $\hat{\beta}_x$ estimates obtained from the nested decomposition indeed decreases with smaller spatial scale, as desired. This is also true for the spectral decomposition.
```{r}
par(mfrow = c(1,2))
testnested = analysis(A = outsim$A, 
                X = outsim$X, 
                Y = outsim$Y, 
                Z = outsim$Z, 
                state = outsim$state,
                decomposition = 'nested')

plot(1:2, testnested, xlab = 'Spatial Scale', ylab = 'betahat', pch = 19, type = 'l', 
     main = 'Nested', xaxp = c(1,2,1), ylim = c(1,3))
points(1:2, testnested, pch = 19)
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')

testspectral = analysis(A = outsim$A, 
                X = outsim$X, 
                Y = outsim$Y, 
                Z = outsim$Z, 
                state = outsim$state,
                decomposition = 'spectral')

plot(1:5, testspectral, xlab = 'Spatial Scale', ylab = 'betahat', pch = 19,
     type = 'l', ylim = c(1,3), main = 'Spectral')
points(1:5, testspectral, pch = 19)
legend('topright', legend = 'True Beta', col = 'red', lty = 1)
abline(h = 2, col = 'red')
```
